name: Deploy Laravel + React (Education Malaysia)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Setup PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, bcmath, intl, pdo, pdo_mysql, xml, curl, zip, gd
          tools: composer

      # 3Ô∏è‚É£ Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # 4Ô∏è‚É£ Install NPM deps
      - name: Install NPM dependencies
        run: npm install --force

      # 5Ô∏è‚É£ Create temporary .env for CI build
      - name: Create temporary .env for CI
        run: |
          cp .env.example .env
          sed -i 's|APP_URL=.*|APP_URL=http://localhost|' .env
          mkdir -p storage/framework/cache
          mkdir -p storage/framework/sessions
          mkdir -p storage/framework/views
          mkdir -p storage/logs
          mkdir -p bootstrap/cache

      # 6Ô∏è‚É£ Install Composer deps
      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction

      # 7Ô∏è‚É£ Generate app key for CI
      - name: Generate Laravel App Key
        run: php artisan key:generate

      # 8Ô∏è‚É£ Build React/Vite assets
      - name: Build Frontend Assets (Vite)
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_API_KEY: ${{ secrets.VITE_API_KEY }}
          VITE_SITE_URL: ${{ secrets.VITE_SITE_URL }}
          VITE_ADMIN_URL: ${{ secrets.VITE_ADMIN_URL }}
          VITE_IMAGE_BASE_URL: ${{ secrets.VITE_IMAGE_BASE_URL }}
        run: |
          echo "VITE_API_BASE_URL=${VITE_API_BASE_URL}" >> .env
          echo "VITE_API_KEY=${VITE_API_KEY}" >> .env
          echo "VITE_SITE_URL=${VITE_SITE_URL}" >> .env
          echo "VITE_ADMIN_URL=${VITE_ADMIN_URL}" >> .env
          echo "VITE_IMAGE_BASE_URL=${VITE_IMAGE_BASE_URL}" >> .env
          npx vite build
          cp public/build/.vite/manifest.json public/build/manifest.json 2>/dev/null || true

      # 9Ô∏è‚É£ Create deploy zip
      - name: Create deployment archive
        run: |
          zip -r deploy.zip . \
            --exclude="*.git*" \
            --exclude="node_modules/*" \
            --exclude=".env" \
            --exclude="deploy.zip" \
            --exclude="tests/*" \
            --exclude="*.md"

      # üîü Upload zip to cPanel
      - name: Upload archive via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "deploy.zip"
          target: ${{ secrets.DEPLOY_PATH }}
          overwrite: true

      # 1Ô∏è‚É£1Ô∏è‚É£ Run Laravel commands on server
      - name: Run Laravel commands on server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}

            unzip -o deploy.zip -d .
            rm -f deploy.zip

            php artisan key:generate --force

            mkdir -p bootstrap/cache
            mkdir -p storage/framework/cache
            mkdir -p storage/framework/sessions
            mkdir -p storage/framework/views
            mkdir -p storage/logs
            mkdir -p storage/app/public
            chmod -R 775 storage bootstrap/cache

            php artisan migrate --force

            rm -rf public/storage
            php artisan storage:link --force

            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear

            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            echo "üöÄ Deployment complete!"
